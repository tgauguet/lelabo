<% title "Abonnement #{@plan.name}" %>
<div class="grey-bckgrnd checkout-cntnr">
  <%= link_to root_path do %><p class="red-color"><span class="image-hovered"></span>Retour à l'accueil</p><% end %>
  <div class="title-cntnr">
    <h1 class="big-white-h1">Monter au niveau <%= @plan.name %></h1>
  </div>
  <% unless @subscription.errors.blank? %>
    <%= @subscription.errors.full_messages.to_sentence %>
  <% end %>
  <div class="card-cntnr">
    <div class="card-steps-cntnr">
      <h3><%= image_tag "checked.png", class: "checked-img" %>Etape 1 : Sélectionnez votre offre</h3>
      <p>Votre sélection : FORMULE <%= @plan.name %></p>
      <i>Facturé annuellement</i>
      <% if @user %><p>Tarif : <%= @plan.amount[0,3] %>,<%= @plan.amount[3,5] %>€ /an</p><% end %>
      <p>Vous pouvez résilier gratuitement votre abonnement à tout moment pendant 14 jours</p>
      <p>Aucun prélèvement ne sera opéré durant la période d'essai</p><br/>
      <p></p>
      <% if @user && @user.business_user? %>
        <p>Votre abonnement PRO débutera à partir de la date de fin de votre abonnement BUSINESS</p>
      <% end %>
      <% if @user && @user.pro_user? %>
        <p>Un prorata de votre abonnement en cours sera effectué et le prix de votre abonnement BUSINESS sera déduit du montant correspondant à la fin de vos droits sur la formule PRO</p>
      <% end %>
      <br/><br/>
      <% if @user %>
      <h3>Etape 2 : Informations de paiement</h3>
      <%= form_for @subscription , html: { id: 'payment-form' } do |f| %>
        <div class="secure-cntnr">
          <%= image_tag "master-card.png", class: "card-img", alt: "carte de crédit" %>
          <%= image_tag "visa.png", class: "card-img", alt: "carte de crédit" %>
          <%= image_tag "carte-bleue.png", class: "card-img", alt: "carte de crédit" %>
          <%= image_tag "american-express.png", class: "card-img", alt: "carte de crédit" %>
          <p>Formulaire sécurisé <%= image_tag "padlock.png", class:"mini-img",alt: "securisé" %></p>
        </div>
        <span class="errors" style='color:red;'></span>
        <% if signed_in? %>
          <%= hidden_field_tag :email, nil, name: "email_address" ,placeholder: 'Email (requis)', :id=>"inscription_field3 rounded-field",  :required => true, value: @user.email %>
        <% else %>
          <p>Email</p>
          <%= text_field_tag :email, nil, name: "email_address" ,placeholder: 'Email (requis)', :class=>"basic-field rounded-field",  :required => true %>
        <% end %>
        <p>Numero de carte</p>
        <input type="hidden" name="plan_id" value="<%= @plan.id %>" />
        <%= text_field_tag :card_number, nil, name: nil ,placeholder: 'Numéro de carte', class: "basic-field cc-number rounded-field", :required => true, id: "cc-number", data: { stripe: "number"}  %><br/>
        <p>Date d'expiration</p>
        <div class="card-nb-cntnr">
          <%= select_month nil, {use_two_digit_numbers: true}, {name: nil, id: "card_month", class: "select-field basic-field",placeholder: 'Enter search term...', :required => true, :data => {:stripe => 'exp-month' }} %>
          <%= select_year nil, {start_year: Date.today.year, end_year: Date.today.year+12}, {name: nil, id: "card_year",placeholder: 'Enter search term...', class: "select-field basic-field",  :required => true, :data => {:stripe => 'exp-year' }} %>
        </div>
        <p>CVC <i class="grey-txt">(3 chiffres au dos de votre carte)</i></p>
        <%= text_field_tag :card_code, nil, name: nil ,placeholder: 'CVC', class: "basic-field rounded-field" , :required => true, data: { stripe: "cvc" } %>
        <br/>
        <p class="float-right"><%= f.submit "TERMINER LA COMMANDE", class: "btn cta-btn" %></p>
      <% end %>
      <% else %>
        <p>Vous devez vous inscrire afin de choisir votre formule d'abonnement</p>
        <p>Commencez par entrer votre email sur la page suivante<br/>(cliquez sur le bouton ci-dessous)</p><br/>
        <p><%= link_to "JE M'INSCRIS", root_path, class: "btn cta-btn" %></p>
      <% end %>
    </div>
  </div>
</div>

<script type="text/javascript">
jQuery(function($) {
  $('#payment-form').submit(function(event) {
    var $form = $(this);

    $form.find('button').prop('disabled', false);

    Stripe.card.createToken($form, stripeResponseHandler);

    return false;
  });
});

var errorMessages = {
  incorrect_number: "Le numéro de la carte est incorrect.",
  invalid_number: "Le numéro de la carte n’est pas un numéro de carte valide.",
  invalid_expiry_month: "Le mois d’expiration de la carte n’est pas valide.",
  invalid_expiry_year: "L’année d’expiration de la carte n’est pas valide.",
  invalid_cvc: "Le code de sécurité de la carte n’est pas valide.",
  expired_card: "La carte a expiré.",
  incorrect_cvc: "Le code de sécurité de la carte est incorrect.",
  incorrect_zip: "La validation du code postal de la carte a échoué.",
  card_declined: "La carte a été refusée.",
  missing: "Aucun client associé à cette carte.",
  processing_error: "Une erreur est survenue lors du contrôle de la carte.",
  rate_limit:  "Une erreur est survenue en raison d'un trop grand nombre de requêtes vers le serveur. Veuillez nous contacter si vous rencontrez cette erreur systématiquement."
};


function stripeResponseHandler(status, response) {
  var $form = $('#payment-form');

  if ( response.error && response.error.type == 'card_error' ){
    $( '.errors' ).text( errorMessages[ response.error.code ] );
  }
  else {
    // response contains id and card, which contains additional card details
    var token = response.id;
    // Insert the token into the form so it gets submitted to the server
    $form.append($('<input type="hidden" name="stripeToken" />').val(token));
    // and submit
    $form.get(0).submit();
  }
};

</script>

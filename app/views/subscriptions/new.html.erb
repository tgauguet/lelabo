    <% unless @subscription.errors.blank? %>
    	<%= @subscription.errors.full_messages.to_sentence %>
    <% end %>
    <h2>Souscrire à l'abonnement : <%= @plan.name %></h2>
    <%= form_for @subscription , html: { id: 'payment-form' } do |f| %>
    	<% if @subscription.errors.any? %>
        	<ul>
            	<% @subscription.errors.full_messages.each do |msg| %>
            		<li><%= msg %></li>
            	<% end %>
        	</ul>
    	<% end %>
      <span class="payment-errors"></span>
    	<input type="hidden" name="plan_id" value="<%= @plan.id %>" />
      <input type="hidden" name="email_address" value="<%= @user.email %>" />
      <%= text_field_tag :card_number, nil, name: nil ,placeholder: 'Numéro de carte', :id=>"inscription_field3", :required => true %>
      <%= label_tag :card_month, "Date d'expiration" %>
      <%= select_month nil, {use_two_digit_numbers: true}, {name: nil, id: "card_month",placeholder: 'Enter search term...', :required => true} %>
      <%= select_year nil, {start_year: Date.today.year, end_year: Date.today.year+12}, {name: nil, id: "card_year",placeholder: 'Enter search term...',  :required => true} %>
      <%= text_field_tag :card_code, nil, name: nil ,placeholder: 'CVC', :id=>"inscription_field5" ,  :required => true %>
      <%= f.submit "Terminer la commande", class: "finish2" %>
    <% end %>

<script type="text/javascript">
jQuery(function($) {
  $('#payment-form').submit(function(event) {
    var $form = $(this);

    $form.find('button').prop('disabled', true);

    Stripe.card.createToken($form, stripeResponseHandler);

    return false;
  });
});

var errorMessages = {
  incorrect_number: "Le numéro de la carte est incorrect.",
  invalid_number: "Le numéro de la carte n’est pas un numéro de carte valide.",
  invalid_expiry_month: "Le mois d’expiration de la carte n’est pas valide.",
  invalid_expiry_year: "L’année d’expiration de la carte n’est pas valide.",
  invalid_cvc: "Le code de sécurité de la carte n’est pas valide.",
  expired_card: "La carte a expiré.",
  incorrect_cvc: "Le code de sécurité de la carte est incorrect.",
  incorrect_zip: "La validation du code postal de la carte a échoué.",
  card_declined: "La carte a été refusée.",
  missing: "Aucun client associé à cette carte.",
  processing_error: "Une erreur est survenue lors du contrôle de la carte.",
  rate_limit:  "Une erreur est survenue en raison d'un trop grand nombre de requêtes vers le serveur. Veuillez nous contacter si vous rencontrez cette erreur systématiquement."
};


function stripeResponseHandler(status, response) {
  var $form = $('#payment-form');
  if ( response.error && response.error.type == 'card_error' ){
    $( '.errors' ).text( errorMessages[ response.error.code ] );
  }
  else {
    // response contains id and card, which contains additional card details
    var token = response.id;
    // Insert the token into the form so it gets submitted to the server
    $form.append($('<input type="hidden" name="stripeToken" />').val(token));
    // and submit
    $form.get(0).submit();
  }
};
</script>
